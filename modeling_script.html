<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Models Available For This Project">

<title>LTBP - Modeling Script</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="LTBP - Modeling Script">
<meta property="og:description" content="Models Available For This Project">
<meta property="og:site-name" content="LTBP">
<meta name="twitter:title" content="LTBP - Modeling Script">
<meta name="twitter:description" content="Models Available For This Project">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">LTBP</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Modeling Script</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Project Overview</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Tutorials</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_preparation_example.html" class="sidebar-item-text sidebar-link">Data Creation Process</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modeling_example.html" class="sidebar-item-text sidebar-link">Iterate Upon a Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calling_library_cli.html" class="sidebar-item-text sidebar-link">Use Your CLI Commands</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Library Scripts</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_creation_script.html" class="sidebar-item-text sidebar-link">Data Creation Script</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modeling_script.html" class="sidebar-item-text sidebar-link active">Modeling Script</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference_script.html" class="sidebar-item-text sidebar-link">Inference Script</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Library Functions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_utils.html" class="sidebar-item-text sidebar-link">Data Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_utilities.html" class="sidebar-item-text sidebar-link">Model Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.html" class="sidebar-item-text sidebar-link">Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_utilities_custom.html" class="sidebar-item-text sidebar-link">Model Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference_utilities.html" class="sidebar-item-text sidebar-link">Inference Utils</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#script" id="toc-script" class="nav-link active" data-scroll-target="#script">Script</a>
  <ul class="collapse">
  <li><a href="#model_train" id="toc-model_train" class="nav-link" data-scroll-target="#model_train">model_train</a></li>
  </ul></li>
  <li><a href="#local-development-code" id="toc-local-development-code" class="nav-link" data-scroll-target="#local-development-code">Local Development Code</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/JeremyDemlow/LTBP/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Modeling Script</h1>
</div>

<div>
  <div class="description">
    Models Available For This Project
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_yaml_file(file_path: <span class="bu">str</span>, file_name: <span class="bu">str</span>, dictionary: <span class="bu">dict</span>):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(Path(file_path, file_name), <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        yaml.dump(dictionary, f)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>models_dict <span class="op">=</span> <span class="bu">dict</span>({</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'preprocessors_adls_path'</span> : <span class="st">'preprocessors/'</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'modeling_adls_path'</span> : <span class="st">'modeling/'</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'predictions_adls_path'</span>: <span class="st">'predictions/'</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'connection_str'</span>: <span class="st">'DATALAKE_CONN_STR_SECRET'</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sas_token'</span> : <span class="st">'DATALAKE_SAS_TOKEN_SECRET'</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'hold_out_table'</span> : <span class="st">'LTBP_HOLDOUT_TEST_MODEL_RESULTS'</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tracking_table'</span> : <span class="st">'LTBP_MODEL_TRACKING_FY23'</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'identification'</span>: [<span class="st">'ECID'</span>, <span class="st">'SEASONYEAR'</span>],</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'inference_sf_table_name'</span>: <span class="st">'LTBP_PREDICTIONS_FY23'</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BASELINE'</span>: {</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Standard baseline xgb_hyperopt approach status quo of LTBP of the past'</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model_trainer'</span>: <span class="st">'train_xgb'</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_preprocess_object_name'</span>: <span class="va">None</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_scaler_type'</span> : <span class="va">None</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x_preprocess_object_name'</span>: <span class="st">'standard_pipe.pickle'</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hyperopt_evals'</span> : <span class="dv">2</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hyper_opt_subsample_size'</span>: <span class="dv">2750000</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'training_subsample_size'</span> : <span class="dv">5000000</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NOHYPEROPT'</span>: {</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'description'</span>: <span class="st">'Only here to see if it works delete at some point xgb_fit_only'</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model_trainer'</span>: <span class="st">'train_xgb_basic'</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_preprocess_object_name'</span>: <span class="va">None</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'y_scaler_type'</span> : <span class="va">None</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'x_preprocess_object_name'</span>: <span class="st">'standard_pipe.pickle'</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hyper_opt_subsample_size'</span> : <span class="st">''</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hyperopt_evals'</span> : <span class="st">''</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'training_subsample_size'</span> : <span class="dv">5000000</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>write_yaml_file(<span class="st">'./LTBP/files/yaml_files/'</span>, <span class="st">'models.yaml'</span>, models_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="script" class="level1">
<h1>Script</h1>
<p>This is the DSDE standard process for using Xboost with hyperopt</p>
<hr>
<p><a href="https://github.com/JeremyDemlow/LTBP/blob/main/LTBP/scripts/modeling.py#L30" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="model_train" class="level3">
<h3 class="anchored" data-anchor-id="model_train">model_train</h3>
<blockquote class="blockquote">
<pre><code> model_train (yaml_file_list:list&lt;YAMLfilestoread&gt;,
              experiment_name:str&lt;YAMLsectiontoread&gt;,
              experiment:&lt;YAMLsectiontoread&gt;,
              test_set:&lt;CreateaTestSetFromTrainingData&gt;, sfSchema:str&lt;devq
              ueriesdevschemaanythingelsewillqueryprojectschema&gt;)</code></pre>
</blockquote>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>yaml_file_list</td>
<td>list <yaml files="" to="" read=""></yaml></td>
<td>noqa:</td>
</tr>
<tr class="even">
<td>experiment_name</td>
<td>str <yaml section="" to="" read=""></yaml></td>
<td>noqa:</td>
</tr>
<tr class="odd">
<td>experiment</td>
<td><yaml section="" to="" read=""></yaml></td>
<td>noqa:</td>
</tr>
<tr class="even">
<td>test_set</td>
<td><create a="" test="" set="" from="" training="" data=""></create></td>
<td>noqa:</td>
</tr>
<tr class="odd">
<td>sfSchema</td>
<td>str <dev queries="" dev="" schema="" anything="" else="" will="" query="" project=""></dev></td>
<td>noqa:</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="local-development-code" class="level1">
<h1>Local Development Code</h1>
<p>Here is where the development of the script can be improved this code should run sequentially happy coding</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>yaml_file_list<span class="op">=</span>[<span class="st">'features.yaml'</span>, <span class="st">'udf_inputs.yaml'</span>,<span class="st">'etl.yaml'</span>,<span class="st">'models.yaml'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>prod_or_dev <span class="op">=</span> <span class="st">'dev'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>experiment_name<span class="op">=</span><span class="st">'BASELINE'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>experiment <span class="op">=</span> <span class="va">True</span> <span class="co"># this will trigger if the feature set needs to be created</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>test_set <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab all yaml files for current probject</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>features, udf_inputs, etl_dict, models_dict <span class="op">=</span> get_yaml_dicts(yaml_file_list)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Snowflake Stage and Query Experiment location or commit location and return training data</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> snowflake_query(sfSchema<span class="op">=</span>prod_or_dev <span class="cf">if</span> prod_or_dev.lower() <span class="op">==</span> <span class="st">'dev'</span> <span class="cf">else</span> <span class="st">'LTBP'</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> create_stage_and_query_stage_sf(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    sf<span class="op">=</span>sf,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    etl<span class="op">=</span>etl_dict,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    udf_inputs<span class="op">=</span>udf_inputs,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    train_or_inference<span class="op">=</span><span class="st">'TRAINING'</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    experiment<span class="op">=</span>experiment,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    indentification<span class="op">=</span>models_dict[<span class="st">'identification'</span>]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing an adls path depending on experiment being true or false</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>adls_path <span class="op">=</span> os.path.join(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    (os.path.join(etl_dict[<span class="st">'data_lake_path'</span>], <span class="st">'experiments'</span>, experiment_name)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> experiment</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>     <span class="cf">else</span> os.path.join(</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>         etl_dict[<span class="st">'data_lake_path'</span>],</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>         os.environ.get(<span class="st">'CI_COMMIT_SHA'</span>, <span class="st">'LocalRunNBS'</span>))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    , models_dict[<span class="st">'preprocessors_adls_path'</span>]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    , models_dict[<span class="st">'BASELINE'</span>][<span class="st">'model_trainer'</span>])</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab all Categorical and Continous Variables for Modeling</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="op">=</span> [{f.upper(): values[<span class="st">'transformation'</span>][experiment_name]} <span class="cf">for</span> f, values <span class="kw">in</span> features.items()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> values[<span class="st">'var_type'</span>][experiment_name] <span class="op">==</span> <span class="st">'cat'</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">and</span> values[<span class="st">'input_definition'</span>] <span class="op">!=</span> <span class="st">'LABEL'</span>]</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>cont_vars <span class="op">=</span> [{f.upper(): values[<span class="st">'transformation'</span>][experiment_name]} <span class="cf">for</span> f, values <span class="kw">in</span> features.items()</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>             <span class="cf">if</span> values[<span class="st">'var_type'</span>][experiment_name] <span class="op">==</span> <span class="st">'cont'</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>             <span class="kw">and</span> values[<span class="st">'input_definition'</span>] <span class="op">!=</span> <span class="st">'LABEL'</span>]</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>y_var <span class="op">=</span> [k.upper() <span class="cf">for</span> k, v <span class="kw">in</span> features.items() <span class="cf">if</span> v[<span class="st">'input_definition'</span>] <span class="op">==</span> <span class="st">'LABEL'</span>]</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Dictionary and create sklearn preprocessing Pipeline</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>feature_dict <span class="op">=</span> create_sklearn_preprocess_baseline_dict(cat_vars<span class="op">=</span>cat_vars,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>                                                       cont_vars<span class="op">=</span>cont_vars)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>logging.info(feature_dict)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="op">=</span> return_list_of_vars(cat_vars)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>cont_vars <span class="op">=</span> return_list_of_vars(cont_vars)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f"categorical variables: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>cat_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f"continous variables: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>cont_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> preprocessing.generate_sklearn_preprocessing_pipeline(</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    feature_dict, impute<span class="op">=</span><span class="va">True</span>, impute_strategy<span class="op">=</span><span class="st">'mean'</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess and split data set to return neccessary object for modeling</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> prepare_training_set(df,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                              y_var<span class="op">=</span>[k.upper() <span class="cf">for</span> k, v <span class="kw">in</span> features.items() <span class="cf">if</span> v[<span class="st">'input_definition'</span>] <span class="op">==</span> <span class="st">'LABEL'</span>],</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                              y_scaler_type<span class="op">=</span>models_dict[experiment_name][<span class="st">'y_scaler_type'</span>],</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                              adls_path<span class="op">=</span>adls_path,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                              sklearn_pipe<span class="op">=</span>pipe,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                              test_set<span class="op">=</span>test_set,</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                              etl_dict<span class="op">=</span>etl_dict,</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                              models_dict<span class="op">=</span>models_dict,</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                              connection_str<span class="op">=</span>os.environ[models_dict[<span class="st">"connection_str"</span>]],</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                              experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                              as_type<span class="op">=</span><span class="bu">int</span>,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                              identifiers<span class="op">=</span>[<span class="st">'ECID'</span>, <span class="st">'SEASONYEAR'</span>]</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>                              )</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test_set:</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    X_train, X_valid, X_test, y_train, y_valid, y_test, sklearn_pipe, scaler, id_list <span class="op">=</span> result</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    X_train, X_valid, y_train, y_valid, sklearn_pipe, scaler, id_list <span class="op">=</span> result</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing model from models.py to use from models.yaml file</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>model_trainer <span class="op">=</span> <span class="bu">getattr</span>(ds_models, models_dict[experiment_name][<span class="st">'model_trainer'</span>])</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_trainer(X_train,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                      X_valid,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                      y_train,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                      y_valid,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                      evals<span class="op">=</span>models_dict[experiment_name][<span class="st">'hyperopt_evals'</span>],</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                      sub<span class="op">=</span>models_dict[experiment_name][<span class="st">'hyper_opt_subsample_size'</span>],</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                      train<span class="op">=</span>models_dict[experiment_name][<span class="st">'training_subsample_size'</span>])</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="co">Custom needs for each project type this works for a binary classification</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="co">this is not my best work, but trying to put something together</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="co">this is dry I am sure i could make this just a few lines</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>result_dict <span class="op">=</span> {}</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="st">'Training Set Evaluation'</span>)</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>eval_list_train <span class="op">=</span> evaluate(model, X_train, y_train, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>metric1, metric2, metric3, columns, _, _, fi_permutation <span class="op">=</span> eval_list_train</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'training_metrics'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'fi_train'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="st">'Validation Set Evaluation'</span>)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>eval_list_valid <span class="op">=</span> evaluate(model, X_valid, y_valid, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>metric1, metric2, metric3, columns, y_pred_proba, y_pred, fi_permutation <span class="op">=</span> eval_list_valid</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'valid_metrics'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'fi_valid'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> X_test <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Test Set Evaluation'</span>)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    eval_list_test <span class="op">=</span> evaluate(model, X_test, y_test, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    metric1, metric2, metric3, columns, y_pred_proba, y_pred, fi_permutation <span class="op">=</span> eval_list_test</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    result_dict[<span class="st">'test_metrics'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    result_dict[<span class="st">'fi_test'</span>] <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> snowflake_query(sfSchema<span class="op">=</span><span class="st">'LTBP'</span>)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>send_holdout_results_to_sf(sf<span class="op">=</span>sf,</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>                           id_list<span class="op">=</span>id_list,</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>                           probs<span class="op">=</span>y_pred_proba,</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>                           experiment<span class="op">=</span>experiment,</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>                           experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>                           etl_dict<span class="op">=</span>etl_dict,</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>                           model_dict<span class="op">=</span>models_dict)</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>adls_path <span class="op">=</span> os.path.join(</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    (os.path.join(etl_dict[<span class="st">'data_lake_path'</span>], <span class="st">'experiments'</span>, experiment_name)</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> experiment <span class="cf">else</span> os.path.join(</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>         etl_dict[<span class="st">'data_lake_path'</span>], os.environ.get(<span class="st">'CI_COMMIT_SHA'</span>, <span class="st">'LocalRunNBS'</span>))</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>custom_project_log <span class="op">=</span> [</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'action_description'</span>: models_dict[experiment_name][<span class="st">"description"</span>],</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transaction_type'</span>: <span class="st">"model_training"</span>,</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">'commitid'</span>: os.getenv(<span class="st">"CI_COMMIT_SHA"</span>, <span class="st">'LocalRunNBS'</span>),</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">'environment'</span>: os.getenv(<span class="st">"prod_or_dev"</span>, <span class="va">None</span>),</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">'branch'</span>: os.getenv(<span class="st">"CI_COMMIT_REF_SLUG"</span>, <span class="va">None</span>),</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">'timestamp'</span>: datetime.datetime.now(pytz.timezone(<span class="st">"US/Mountain"</span>)).strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>),</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">'artifacts'</span>: json.dumps({<span class="st">"azure_parent_folder"</span>: adls_path}),</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">'metrics'</span>: json.dumps(result_dict),</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">'experiment_name'</span> : experiment_name,</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">'experiment'</span> : experiment,</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">'production_model'</span> : <span class="va">False</span>,</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ever_production'</span> : <span class="va">False</span>,              </span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>project_log_df <span class="op">=</span> project_log.project_log(</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>    snowflake_connection<span class="op">=</span>sf,</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>    table_name<span class="op">=</span>models_dict[<span class="st">'tracking_table'</span>],</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>    custom_schema<span class="op">=</span>custom_project_log,</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>    append_or_replace<span class="op">=</span><span class="st">"append"</span>,</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f'project log preview:</span><span class="ch">\n</span><span class="sc">{</span>project_log_df<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f'project log values preview:</span><span class="ch">\n</span><span class="sc">{</span>project_log_df<span class="sc">.</span>loc[<span class="dv">0</span>]<span class="sc">.</span>values<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving sklearn pipeline to adls</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="st">'Saving model and sending it to adls'</span>)</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>full_pipeline <span class="op">=</span> Pipeline([(<span class="st">'preprocessing'</span>, pipe), (<span class="st">'classification'</span>, model)])</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>adls_path <span class="op">=</span> os.path.join(adls_path</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>                         , models_dict[<span class="st">'modeling_adls_path'</span>]</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>                         , models_dict[<span class="st">'BASELINE'</span>][<span class="st">'model_trainer'</span>])</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>save_sklearn_object_to_data_lake(</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>    save_object<span class="op">=</span>full_pipeline,</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>    adls_path<span class="op">=</span>adls_path,</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>    file_name<span class="op">=</span>(models_dict[experiment_name][<span class="st">'model_trainer'</span>]<span class="op">+</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>               os.environ.get(<span class="st">'CI_COMMIT_SHA'</span>, <span class="st">'LocalRunNBS'</span>)<span class="op">+</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>               experiment_name<span class="op">+</span><span class="st">'.pkl'</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>    container_name<span class="op">=</span>etl_dict[<span class="st">'azure_container'</span>],</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>    connection_str<span class="op">=</span>os.environ[models_dict[<span class="st">'connection_str'</span>]]</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:data_system_utilities.snowflake.utils:stage_query: 
 create or replace stage ltbpFY23LocalRunTest
url='azure://vaildtscadls.blob.core.windows.net/vailadls/projects/LTBP/FY23/experiments/BASELINE'
credentials=(azure_sas_token='**MASKED**')
encryption=(type= 'NONE')
file_format = (type = parquet        )
INFO:data_system_utilities.snowflake.utils:connection to snowflake established...
INFO:data_system_utilities.snowflake.query:executing query
INFO:data_system_utilities.snowflake.query:data loaded from snowflake
INFO:data_system_utilities.snowflake.query:connection to snowflake has been turned off
INFO:data_system_utilities.snowflake.query:Stage area LTBPFY23LOCALRUNTEST successfully created.
INFO:root:adls snowflake stage query 
    select
    $1:"ECID"::varchar as ECID
, $1:"SEASONYEAR"::varchar as SEASONYEAR
, $1:"AGE"::varchar as AGE
, $1:"AVGVISITPERSEASON"::varchar as AVGVISITPERSEASON
, $1:"BOUGHTPASS"::varchar as BOUGHTPASS
, $1:"DESTINATIONGEOAFINITYLABEL"::varchar as DESTINATIONGEOAFINITYLABEL
, $1:"EVERCOREPASS"::varchar as EVERCOREPASS
, $1:"EVERPASS"::varchar as EVERPASS
, $1:"GENDERCODE"::varchar as GENDERCODE
, $1:"GUESTBEHAVIOR"::varchar as GUESTBEHAVIOR
, $1:"ISEPICMIXACTIVATED"::varchar as ISEPICMIXACTIVATED
, $1:"MARKETINGZONE"::varchar as MARKETINGZONE
, $1:"MOSTCOMMONTICKETCOMP"::varchar as MOSTCOMMONTICKETCOMP
, $1:"MOSTSUBSEASONVISITED"::varchar as MOSTSUBSEASONVISITED
, $1:"MOSTVISITEDREGION"::varchar as MOSTVISITEDREGION
, $1:"MOSTVISITEDRESORT"::varchar as MOSTVISITEDRESORT
, $1:"ONLYSINGLERESORTKEY"::varchar as ONLYSINGLERESORTKEY
, $1:"PARTNERRESORTSCANNERFLAG"::varchar as PARTNERRESORTSCANNERFLAG
, $1:"RESORTSVISITED"::varchar as RESORTSVISITED
, $1:"SKIERABILITYLABEL"::varchar as SKIERABILITYLABEL
, $1:"SUBSEASONSPERYEAR"::varchar as SUBSEASONSPERYEAR
, $1:"TOTALSEASONSSCANNED"::varchar as TOTALSEASONSSCANNED
, $1:"TOTALVISITS"::varchar as TOTALVISITS
, $1:"VISITMOSTINPEAK"::varchar as VISITMOSTINPEAK

    from @ltbpFY23LocalRunTest/training_data/
    None
    
INFO:data_system_utilities.snowflake.utils:connection to snowflake established...
INFO:data_system_utilities.snowflake.query:executing query
INFO:data_system_utilities.snowflake.query:data loaded from snowflake
INFO:data_system_utilities.snowflake.query:connection to snowflake has been turned off
INFO:root:Preview dataframe queried        ECID SEASONYEAR AGE AVGVISITPERSEASON BOUGHTPASS  \
0  49436302    2018/19  11                 1          0   
1  80007527    2018/19  31              16.5          1   
2  75608339    2018/19  47               2.5          0   
3  27418903    2018/19  23                19          0   
4  62624119    2018/19  38               9.5          1   

  DESTINATIONGEOAFINITYLABEL EVERCOREPASS EVERPASS GENDERCODE GUESTBEHAVIOR  \
0                Destination            0        0          M       PY Paid   
1                      Local            1        1          M       PY Paid   
2                Destination            0        0          F       PY Paid   
3                      Local            1        1          M      Prospect   
4                Destination            1        1          M       PY Paid   

   ...  MOSTVISITEDREGION MOSTVISITEDRESORT ONLYSINGLERESORTKEY  \
0  ...  Pacific Southwest                 8                   8   
1  ...     Rocky Mountain                 3                None   
2  ...  Pacific Northwest                18                None   
3  ...     Rocky Mountain                15                None   
4  ...          Northeast                19                None   

  PARTNERRESORTSCANNERFLAG RESORTSVISITED SKIERABILITYLABEL SUBSEASONSPERYEAR  \
0                        0              1              None                 1   
1                        0              2          Advanced               5.5   
2                        0              2      Intermediate                 1   
3                        0              1          Advanced               7.5   
4                        0              2              None                 2   

  TOTALSEASONSSCANNED TOTALVISITS VISITMOSTINPEAK  
0                   1           1               1  
1                   2          33               1  
2                   2           5               1  
3                   2          38               0  
4                   2          19               1  

[5 rows x 24 columns]
INFO:root:{'DESTINATIONGEOAFINITYLABEL': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'EVERCOREPASS': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'EVERPASS': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'GENDERCODE': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'GUESTBEHAVIOR': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'ISEPICMIXACTIVATED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MARKETINGZONE': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTCOMMONTICKETCOMP': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTSUBSEASONVISITED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTVISITEDREGION': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTVISITEDRESORT': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'ONLYSINGLERESORTKEY': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'PARTNERRESORTSCANNERFLAG': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'SKIERABILITYLABEL': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'TOTALSEASONSSCANNED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'VISITMOSTINPEAK': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'AGE': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'AVGVISITPERSEASON': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'RESORTSVISITED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'SUBSEASONSPERYEAR': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'TOTALVISITS': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}}
INFO:root:categorical variables: 
 ['DESTINATIONGEOAFINITYLABEL', 'EVERCOREPASS', 'EVERPASS', 'GENDERCODE', 'GUESTBEHAVIOR', 'ISEPICMIXACTIVATED', 'MARKETINGZONE', 'MOSTCOMMONTICKETCOMP', 'MOSTSUBSEASONVISITED', 'MOSTVISITEDREGION', 'MOSTVISITEDRESORT', 'ONLYSINGLERESORTKEY', 'PARTNERRESORTSCANNERFLAG', 'SKIERABILITYLABEL', 'TOTALSEASONSSCANNED', 'VISITMOSTINPEAK']
INFO:root:continous variables: 
 ['AGE', 'AVGVISITPERSEASON', 'RESORTSVISITED', 'SUBSEASONSPERYEAR', 'TOTALVISITS']
INFO:machine_learning_utilities.preprocessing:Creating Sklearn Preprocessing Pipeline
INFO:machine_learning_utilities.preprocessing:Feature: DESTINATIONGEOAFINITYLABEL --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:machine_learning_utilities.preprocessing:Feature: EVERCOREPASS --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: EVERPASS --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: GENDERCODE --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: GUESTBEHAVIOR --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: ISEPICMIXACTIVATED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MARKETINGZONE --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTCOMMONTICKETCOMP --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTSUBSEASONVISITED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTVISITEDREGION --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTVISITEDRESORT --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: ONLYSINGLERESORTKEY --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: PARTNERRESORTSCANNERFLAG --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: SKIERABILITYLABEL --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: TOTALSEASONSSCANNED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: VISITMOSTINPEAK --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: AGE --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: AVGVISITPERSEASON --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: RESORTSVISITED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: SUBSEASONSPERYEAR --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: TOTALVISITS --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Imputing missing data with mean strategy
INFO:machine_learning_utilities.preprocessing:Preprocessing Pipeline Object:
Pipeline(steps=[('preprocessing',
                 FeatureUnion(transformer_list=[('pipeline-1',
                                                 Pipeline(steps=[('functiontransformer',
                                                                  FunctionTransformer(func=&lt;function get_cat_cols&gt;,
                                                                                      kw_args={'cols': ['DESTINATIONGEOAFINITYLABEL']})),
                                                                 ('ordinalencoder',
                                                                  OrdinalEncoder(handle_unknown='use_encoded_value',
                                                                                 unknown_value=-1))])),
                                                ('pipeline-2',
                                                 Pipeline(steps=[('...
                                                                  FunctionTransformer(func=&lt;function get_cont_cols&gt;,
                                                                                      kw_args={'cols': ['SUBSEASONSPERYEAR']})),
                                                                 ('standardscaler',
                                                                  StandardScaler())])),
                                                ('pipeline-21',
                                                 Pipeline(steps=[('functiontransformer',
                                                                  FunctionTransformer(func=&lt;function get_cont_cols&gt;,
                                                                                      kw_args={'cols': ['TOTALVISITS']})),
                                                                 ('standardscaler',
                                                                  StandardScaler())]))])),
                ('imputing', SimpleImputer())])
INFO:root:Successfully Spilt Data
Train: (24000, 24), (24000, 1)
Valid: (5100, 24), (5100, 1)
Test: (900, 24), (900, 1)
INFO:root:Size of the id_list for the hold set (900, 2)
INFO:root:This project relies on the query to have accurate labels with no preprocessing..
INFO:root:Pushing Sklearn Object to Azure: projects/LTBP/FY23/experiments/BASELINE/preprocessors/train_xgb/LocalRunTeststandard_pipe.pickle
INFO:data_system_utilities.azure.storage:Uploading LocalRunTeststandard_pipe.pickle, to Azure Storage projects/LTBP/FY23/experiments/BASELINE/preprocessors/train_xgb/LocalRunTeststandard_pipe.pickle
INFO:data_system_utilities.azure.storage:Azure Upload Complete
INFO:root:LocalRunTeststandard_pipe.pickle successfully pushed to projects/LTBP/FY23/experiments/BASELINE/preprocessors/train_xgb
INFO:root:Hyper tuning on 24000 rows</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%|                                   | 0/2 [00:00&lt;?, ?trial/s, best loss=?]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:hyperopt.tpe:build_posterior_wrapper took 0.007822 seconds
INFO:hyperopt.tpe:TPE using 0 trials</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> 50%|████    | 1/2 [00:08&lt;00:08,  8.58s/trial, best loss: 0.09631553418146976]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:hyperopt.tpe:build_posterior_wrapper took 0.008316 seconds
INFO:hyperopt.tpe:TPE using 1/1 trials with best loss 0.096316</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>100%|████████| 2/2 [00:12&lt;00:00,  6.34s/trial, best loss: 0.09087793146491441]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Full training on 24000 rows</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Training Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.905    Accuracy: 0.834    Balanced Accuracy: 0.836
INFO:root:Feature Importance df: 
                           COLS     IMP
0                     EVERPASS  0.2648
1         MOSTCOMMONTICKETCOMP  0.0264
2            SUBSEASONSPERYEAR  0.0158
3                GUESTBEHAVIOR  0.0110
4                          AGE  0.0068
5          TOTALSEASONSSCANNED  0.0068
6                  TOTALVISITS  0.0036
7                 EVERCOREPASS  0.0036
8   DESTINATIONGEOAFINITYLABEL  0.0032
9            AVGVISITPERSEASON  0.0024
10           MOSTVISITEDREGION  0.0022
11         ONLYSINGLERESORTKEY  0.0020
12           SKIERABILITYLABEL  0.0020
13              RESORTSVISITED  0.0020
14        MOSTSUBSEASONVISITED  0.0016
15          ISEPICMIXACTIVATED  0.0012
16                  GENDERCODE  0.0004
17    PARTNERRESORTSCANNERFLAG  0.0002
18               MARKETINGZONE  0.0002
19           MOSTVISITEDRESORT  0.0002
20             VISITMOSTINPEAK  0.0000</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-11.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-12.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Validation Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.905    Accuracy: 0.834    Balanced Accuracy: 0.835
INFO:root:Feature Importance df: 
                           COLS     IMP
0                     EVERPASS  0.2576
1         MOSTCOMMONTICKETCOMP  0.0266
2            SUBSEASONSPERYEAR  0.0138
3                GUESTBEHAVIOR  0.0110
4          TOTALSEASONSSCANNED  0.0064
5                  TOTALVISITS  0.0026
6                 EVERCOREPASS  0.0026
7   DESTINATIONGEOAFINITYLABEL  0.0022
8            SKIERABILITYLABEL  0.0020
9           ISEPICMIXACTIVATED  0.0018
10        MOSTSUBSEASONVISITED  0.0014
11         ONLYSINGLERESORTKEY  0.0012
12                         AGE  0.0010
13              RESORTSVISITED  0.0010
14    PARTNERRESORTSCANNERFLAG  0.0004
15           AVGVISITPERSEASON  0.0002
16               MARKETINGZONE -0.0002
17             VISITMOSTINPEAK -0.0002
18           MOSTVISITEDREGION -0.0004
19           MOSTVISITEDRESORT -0.0006
20                  GENDERCODE -0.0010</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-14.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-15.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-16.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Test Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.883    Accuracy: 0.799    Balanced Accuracy: 0.802
INFO:root:Feature Importance df: 
                           COLS       IMP
0                     EVERPASS  0.230000
1            SUBSEASONSPERYEAR  0.033333
2         MOSTCOMMONTICKETCOMP  0.026667
3                 EVERCOREPASS  0.010000
4                  TOTALVISITS  0.006667
5                GUESTBEHAVIOR  0.005556
6            MOSTVISITEDREGION  0.003333
7            AVGVISITPERSEASON  0.003333
8   DESTINATIONGEOAFINITYLABEL  0.003333
9              VISITMOSTINPEAK  0.002222
10                         AGE  0.002222
11        MOSTSUBSEASONVISITED  0.001111
12    PARTNERRESORTSCANNERFLAG  0.001111
13         TOTALSEASONSSCANNED  0.001111
14           SKIERABILITYLABEL  0.000000
15              RESORTSVISITED  0.000000
16           MOSTVISITEDRESORT  0.000000
17               MARKETINGZONE -0.002222
18                  GENDERCODE -0.002222
19          ISEPICMIXACTIVATED -0.003333
20         ONLYSINGLERESORTKEY -0.004444</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-18.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-19.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-20.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:hold out data preview going to snowflake             ECID SEASONYEAR  PROBABILITY          DATECREATED  \
14448  102541768    2019/20     0.188354  2022-11-03 14:26:03   
12515  103317074    2019/20     0.158204  2022-11-03 14:26:03   
2167    56452604    2019/20     0.508148  2022-11-03 14:26:03   

           EXP_COMMIT_CI_SHA  
14448  BASELINE_LocalRunTest  
12515  BASELINE_LocalRunTest  
2167   BASELINE_LocalRunTest  
INFO:data_system_utilities.snowflake.query:creating table LTBP_HOLDOUT_TEST_MODEL_RESULTS
INFO:data_system_utilities.snowflake.query:sqlalchemy snowflake engine created
INFO:data_system_utilities.snowflake.query:table created
INFO:root:saving test prediction file
INFO:root:sending prediction file to azure to projects/LTBP/FY23/experiments/BASELINE/holdout_results/train_xgb/
INFO:data_system_utilities.azure.storage:Uploading holdout_BASELINELocalRunTest.csv, to Azure Storage projects/LTBP/FY23/experiments/BASELINE/holdout_results/train_xgb/holdout_BASELINELocalRunTest.csv
INFO:data_system_utilities.azure.storage:Azure Upload Complete
INFO:data_system_utilities.snowflake.query:creating table LTBP_MODEL_TRACKING_FY23
INFO:data_system_utilities.snowflake.query:sqlalchemy snowflake engine created
INFO:data_system_utilities.snowflake.query:table created
INFO:root:project log preview:
                                  ACTION_DESCRIPTION TRANSACTION_TYPE  \
0  Standard baseline xgb_hyperopt approach status...   model_training   

       COMMITID ENVIRONMENT  BRANCH            TIMESTAMP  \
0  LocalRunTest         dev  random  2022-11-03 15:26:08   

                                           ARTIFACTS  \
0  {"azure_parent_folder": "projects/LTBP/FY23/ex...   

                                             METRICS EXPERIMENT_NAME  \
0  {"training_metrics": {"auc": 0.905141572110986...        BASELINE   

   EXPERIMENT  PRODUCTION_MODEL  EVER_PRODUCTION  
0        True             False            False  
INFO:root:project log values preview:
['Standard baseline xgb_hyperopt approach status quo of LTBP of the past'
 'model_training' 'LocalRunTest' 'dev' 'random' '2022-11-03 15:26:08'
 '{"azure_parent_folder": "projects/LTBP/FY23/experiments/BASELINE"}'
 '{"training_metrics": {"auc": 0.9051415721109867, "acc": 0.8343333333333334, "bacc": 0.8355776247859253}, "fi_train": {"EVERPASS": 0.2647999999999999, "MOSTCOMMONTICKETCOMP": 0.02639999999999998, "SUBSEASONSPERYEAR": 0.015799999999999925, "GUESTBEHAVIOR": 0.01100000000000001, "AGE": 0.006799999999999917, "TOTALSEASONSSCANNED": 0.006799999999999917, "TOTALVISITS": 0.0035999999999999366, "EVERCOREPASS": 0.0035999999999999366, "DESTINATIONGEOAFINITYLABEL": 0.0031999999999999806, "AVGVISITPERSEASON": 0.0023999999999999577}, "valid_metrics": {"auc": 0.9047741862633534, "acc": 0.8341176470588235, "bacc": 0.8350952288136023}, "fi_valid": {"EVERPASS": 0.25760000000000005, "MOSTCOMMONTICKETCOMP": 0.026599999999999957, "SUBSEASONSPERYEAR": 0.013800000000000034, "GUESTBEHAVIOR": 0.01100000000000001, "TOTALSEASONSSCANNED": 0.006399999999999961, "TOTALVISITS": 0.0026000000000000467, "EVERCOREPASS": 0.0026000000000000467, "DESTINATIONGEOAFINITYLABEL": 0.0021999999999999797, "SKIERABILITYLABEL": 0.0020000000000000018, "ISEPICMIXACTIVATED": 0.0018000000000000238}, "test_metrics": {"auc": 0.8831961530080624, "acc": 0.7988888888888889, "bacc": 0.8017026207880192}, "fi_test": {"EVERPASS": 0.22999999999999998, "SUBSEASONSPERYEAR": 0.033333333333333326, "MOSTCOMMONTICKETCOMP": 0.026666666666666616, "EVERCOREPASS": 0.010000000000000009, "TOTALVISITS": 0.006666666666666599, "GUESTBEHAVIOR": 0.005555555555555536, "MOSTVISITEDREGION": 0.0033333333333332993, "AVGVISITPERSEASON": 0.0033333333333332993, "DESTINATIONGEOAFINITYLABEL": 0.0033333333333332993, "VISITMOSTINPEAK": 0.0022222222222222365}}'
 'BASELINE' True False False]
INFO:root:Saving model and sending it to adls
INFO:root:Pushing Sklearn Object to Azure: projects/LTBP/FY23/experiments/BASELINE/modeling/train_xgb/train_xgbLocalRunTestBASELINE.pkl
INFO:data_system_utilities.azure.storage:Uploading train_xgbLocalRunTestBASELINE.pkl, to Azure Storage projects/LTBP/FY23/experiments/BASELINE/modeling/train_xgb/train_xgbLocalRunTestBASELINE.pkl
INFO:data_system_utilities.azure.storage:Azure Upload Complete
INFO:root:train_xgbLocalRunTestBASELINE.pkl successfully pushed to projects/LTBP/FY23/experiments/BASELINE/modeling/train_xgb</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="01c_Modeling_Script_files/figure-html/cell-4-output-22.png" class="img-fluid"></p>
</div>
</div>
<p>These just help clean up the tables that would be created by this notebook make sure you only use the below code when in development otherwise you production or your dev results that you have could be deleted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sf.run_sql_str(f"DROP TABLE {models_dict['tracking_table']}")</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sf.run_sql_str(f"DROP TABLE MACHINELEARNINGOUTPUTS.dev.{models_dict['hold_out_table']}")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>