<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Models Available For This Project To Play With Locally">

<title>LTBP - Iterate Upon a Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="LTBP - Iterate Upon a Model">
<meta property="og:description" content="Models Available For This Project To Play With Locally">
<meta property="og:site-name" content="LTBP">
<meta name="twitter:title" content="LTBP - Iterate Upon a Model">
<meta name="twitter:description" content="Models Available For This Project To Play With Locally">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">LTBP</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Iterate Upon a Model</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Project Overview</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Tutorials</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_preparation_example.html" class="sidebar-item-text sidebar-link">Data Creation Process</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modeling_example.html" class="sidebar-item-text sidebar-link active">Iterate Upon a Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calling_library_cli.html" class="sidebar-item-text sidebar-link">Use Your CLI Commands</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Library Scripts</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_creation_script.html" class="sidebar-item-text sidebar-link">Data Creation Script</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./modeling_script.html" class="sidebar-item-text sidebar-link">Modeling Script</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference_script.html" class="sidebar-item-text sidebar-link">Inference Script</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Library Functions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data_utils.html" class="sidebar-item-text sidebar-link">Data Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_utilities.html" class="sidebar-item-text sidebar-link">Model Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.html" class="sidebar-item-text sidebar-link">Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_utilities_custom.html" class="sidebar-item-text sidebar-link">Model Utils</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference_utilities.html" class="sidebar-item-text sidebar-link">Inference Utils</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#create-data-from-data_creation-script" id="toc-create-data-from-data_creation-script" class="nav-link" data-scroll-target="#create-data-from-data_creation-script">Create Data From <code>data_creation</code> Script</a></li>
  <li><a href="#grab-data-from-experiment" id="toc-grab-data-from-experiment" class="nav-link" data-scroll-target="#grab-data-from-experiment">Grab Data From Experiment</a></li>
  <li><a href="#preprocess-training-data" id="toc-preprocess-training-data" class="nav-link" data-scroll-target="#preprocess-training-data">Preprocess Training Data</a>
  <ul class="collapse">
  <li><a href="#training-model" id="toc-training-model" class="nav-link" data-scroll-target="#training-model">Training Model</a>
  <ul class="collapse">
  <li><a href="#how-to-change-model-in-notebook" id="toc-how-to-change-model-in-notebook" class="nav-link" data-scroll-target="#how-to-change-model-in-notebook">How to Change Model In Notebook</a></li>
  <li><a href="#train-model" id="toc-train-model" class="nav-link" data-scroll-target="#train-model">Train Model</a></li>
  </ul></li>
  <li><a href="#evaluating-model-results" id="toc-evaluating-model-results" class="nav-link" data-scroll-target="#evaluating-model-results">Evaluating Model Results</a></li>
  </ul></li>
  <li><a href="#final-remarks" id="toc-final-remarks" class="nav-link" data-scroll-target="#final-remarks">Final Remarks</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/JeremyDemlow/LTBP/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Iterate Upon a Model</h1>
</div>

<div>
  <div class="description">
    Models Available For This Project To Play With Locally
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This example aims to aid a data scientist or MLEs that would like to train their model in a notebook locally and see what the results would be with out sending results to snowflake. Most MLEs and Data Scientist love to experiment and this notebook aims to allow a user to test different model types</p>
<p>the form of a notebook that does not need to have a full pipeline to wait to be able to see the results or the model artifact. This example aims to show how a DS could quickly iterate and tune their approach rather than going in a pipeline and waiting for results.</p>
<p>There will be a future example in post analysis work, which is extremely fun work, but is currently outside of the goal of this process.</p>
<p>This would mean we would need a new feature set, more thought worthy base query for eligible guest to build upon, and a new call to our dependent variable for BOUGHTPASS to push out to three years. This structure wouldn’t need to change to this point and we would quickly iterate to see if we can get a model that can predict that question.</p>
<p>Obviously, there is more to it than that and the post analysis work would be much more rigorous as this would be a net new model not something that has performed well over the past couple of years.</p>
<p><strong>What we will accomplish</strong>:</p>
<ol type="1">
<li><p>Pulling data from your experiment data creation.</p></li>
<li><p>Train your model using one of the models of your choice from your library.</p></li>
<li><p>Having the ability to use your model locally for your desired way of evaluating.</p></li>
</ol>
<blockquote class="blockquote">
<p>There are so many repos inside of <a href="https://gitlab.com/VailResorts">Gitlab Vail Resorts</a> that have so many different types of analysis approaches that the section on desired way of evaluating that if you need a spark go there and look around in the notebooks there is amazing work there.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Warning</strong>: this is a draft to get something out that is something that gets the majority of a project work flow that exists right now</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>WARINING</strong> To be able to use your scripts you need to install your library so make sure you pip install . in your terminal</p>
</blockquote>
</section>
<section id="create-data-from-data_creation-script" class="level2">
<h2 class="anchored" data-anchor-id="create-data-from-data_creation-script">Create Data From <a href="https://JeremyDemlow.github.io/LTBP/data_creation_script.html#data_creation"><code>data_creation</code></a> Script</h2>
<p>This will create your data for your training set this can take some time depending on your query.</p>
<p>Below is the output of what it would look like if you were to call the data creation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ! data_creation  --train_or_inference "TRAINING" --experiment_name "BASELINE"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ! data_creation  --train_or_inference 'INFERENCE' --experiment_name 'BASELINE'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/Users/jeremydemlow/miniforge3/envs/ltbp/lib/python3.9/site-packages/snowflake/connector/options.py:96: UserWarning: You have an incompatible version of 'pyarrow' installed (6.0.0), please install a version that adheres to: 'pyarrow&lt;8.1.0,&gt;=8.0.0; extra == "pandas"'
  warn_incompatible_dep(
INFO:root:This is a production run
INFO:root:Loading Yaml Files..
INFO:root:Generating Feature Set Query
INFO:root:static features in data set: 
 ['DESTINATIONGEOAFINITYLABEL', 'GenderCode']
INFO:root:temporal features in data set: 
 ['Age', 'AvgVisitPerSeason', 'BoughtPass', 'EverCorePass', 'EverPass', 'GuestBehavior', 'IsEpicMixActivated', 'MarketingZone', 'MostCommonTicketComp', 'MostSubSeasonVisited', 'MostVisitedRegion', 'MostVisitedResort', 'OnlySingleResortKey', 'PartnerResortScannerFlag', 'ResortsVisited', 'SkierabilityLabel', 'SubSeasonsPerYear', 'TotalSeasonsScanned', 'TotalVisits', 'VisitMostInPeak']
INFO:root:Appending static feature DESTINATIONGEOAFINITYLABEL to query
INFO:root:Appending static feature GenderCode to query
INFO:root:Finished appending static features
INFO:root:reading training_ecids_18_19.sql for base query...
INFO:root:reading training_ecids_19_20.sql for base query...
INFO:root:reading training_ecids_20_21.sql for base query...
INFO:root:final query output: 
 select
base.*
, joined.DESTINATIONGEOAFINITYLABEL
, joined.GenderCode
, MACHINELEARNINGFEATURES.PROD.Age_ECID_Temporal(base.ECID, 20171001, 20191005) as Age, MACHINELEARNINGFEATURES.PROD.AvgVisitPerSeason_ECID_Temporal(base.ECID, 20171001, 20191005) as AvgVisitPerSeason, MACHINELEARNINGFEATURES.PROD.BoughtPass_ECID_Temporal(base.ECID, '2019/20') as BoughtPass, MACHINELEARNINGFEATURES.PROD.EverCorePass_ECID_Temporal(base.ECID, 20151005, 20191005) as EverCorePass, MACHINELEARNINGFEATURES.PROD.EverPass_ECID_Temporal(base.ECID, 20151005, 20191005) as EverPass, MACHINELEARNINGFEATURES.PROD.GuestBehavior_ECID_Temporal(base.ECID, '2017/18') as GuestBehavior, MACHINELEARNINGFEATURES.PROD.IsEpicMixActivated_ECID_Temporal(base.ECID, '2017/18') as IsEpicMixActivated, MACHINELEARNINGFEATURES.PROD.MarketingZone_ECID_Temporal(base.ECID, '2017/18') as MarketingZone, MACHINELEARNINGFEATURES.PROD.MostCommonTicketComp_ECID_Temporal(base.ECID, 20171001, 20191005) as MostCommonTicketComp, MACHINELEARNINGFEATURES.PROD.MostSubSeasonVisited_ECID_Temporal(base.ECID, 20171001, 20191005) as MostSubSeasonVisited, MACHINELEARNINGFEATURES.PROD.MostVisitedRegion_ECID_Temporal(base.ECID, 20171001, 20191005) as MostVisitedRegion, MACHINELEARNINGFEATURES.PROD.MostVisitedResort_ECID_Temporal(base.ECID, 20171001, 20191005) as MostVisitedResort, MACHINELEARNINGFEATURES.PROD.OnlySingleResortKey_ECID_Temporal(base.ECID, 20171001, 20191005) as OnlySingleResortKey, MACHINELEARNINGFEATURES.PROD.PartnerResortScannerFlag_ECID_Temporal(base.ECID, 20171001, 20191005) as PartnerResortScannerFlag, MACHINELEARNINGFEATURES.PROD.ResortsVisited_ECID_Temporal(base.ECID, 20171001, 20191005) as ResortsVisited, MACHINELEARNINGFEATURES.PROD.SkierabilityLabel_ECID_Temporal(base.ECID, '2017/18') as SkierabilityLabel, MACHINELEARNINGFEATURES.PROD.SubSeasonsPerYear_ECID_Temporal(base.ECID, 20171001, 20191005) as SubSeasonsPerYear, MACHINELEARNINGFEATURES.PROD.TotalSeasonsScanned_ECID_Temporal(base.ECID, 20171001, 20191005) as TotalSeasonsScanned, MACHINELEARNINGFEATURES.PROD.TotalVisits_ECID_Temporal(base.ECID, 20171001, 20191005) as TotalVisits, MACHINELEARNINGFEATURES.PROD.VisitMostInPeak_ECID_Temporal(base.ECID, 20171001, 20191005) as VisitMostInPeak

, '2018/19' as SEASONYEAR
from
(select
distinct fs.ECID as ecid,
dd.SeasonYear as SeasonYear
from BIDE_EDWDB_ARA_PROD.dbo.FactScan fs
left join BIDE_EDWDB_ARA_PROD.dbo.DimDateSeason dd
on dd.DateSeasonKey = fs.DateSeasonKey
where
dd.SeasonYear in ('2018/19')
and fs.IsEmployee = 0
and dd.Season = 'Winter'
LIMIT 10000
)base
inner join machinelearningfeatures.prod.featurestore_ecid joined on joined.ecid = base.ecid 
UNION ALL
select
base.*
, joined.DESTINATIONGEOAFINITYLABEL
, joined.GenderCode
, MACHINELEARNINGFEATURES.PROD.Age_ECID_Temporal(base.ECID, 20181001, 20201005) as Age, MACHINELEARNINGFEATURES.PROD.AvgVisitPerSeason_ECID_Temporal(base.ECID, 20181001, 20201005) as AvgVisitPerSeason, MACHINELEARNINGFEATURES.PROD.BoughtPass_ECID_Temporal(base.ECID, '2020/21') as BoughtPass, MACHINELEARNINGFEATURES.PROD.EverCorePass_ECID_Temporal(base.ECID, 20151005, 20201005) as EverCorePass, MACHINELEARNINGFEATURES.PROD.EverPass_ECID_Temporal(base.ECID, 20151005, 20201005) as EverPass, MACHINELEARNINGFEATURES.PROD.GuestBehavior_ECID_Temporal(base.ECID, '2018/19') as GuestBehavior, MACHINELEARNINGFEATURES.PROD.IsEpicMixActivated_ECID_Temporal(base.ECID, '2018/19') as IsEpicMixActivated, MACHINELEARNINGFEATURES.PROD.MarketingZone_ECID_Temporal(base.ECID, '2018/19') as MarketingZone, MACHINELEARNINGFEATURES.PROD.MostCommonTicketComp_ECID_Temporal(base.ECID, 20181001, 20201005) as MostCommonTicketComp, MACHINELEARNINGFEATURES.PROD.MostSubSeasonVisited_ECID_Temporal(base.ECID, 20181001, 20201005) as MostSubSeasonVisited, MACHINELEARNINGFEATURES.PROD.MostVisitedRegion_ECID_Temporal(base.ECID, 20181001, 20201005) as MostVisitedRegion, MACHINELEARNINGFEATURES.PROD.MostVisitedResort_ECID_Temporal(base.ECID, 20181001, 20201005) as MostVisitedResort, MACHINELEARNINGFEATURES.PROD.OnlySingleResortKey_ECID_Temporal(base.ECID, 20181001, 20201005) as OnlySingleResortKey, MACHINELEARNINGFEATURES.PROD.PartnerResortScannerFlag_ECID_Temporal(base.ECID, 20181001, 20201005) as PartnerResortScannerFlag, MACHINELEARNINGFEATURES.PROD.ResortsVisited_ECID_Temporal(base.ECID, 20181001, 20201005) as ResortsVisited, MACHINELEARNINGFEATURES.PROD.SkierabilityLabel_ECID_Temporal(base.ECID, '2018/19') as SkierabilityLabel, MACHINELEARNINGFEATURES.PROD.SubSeasonsPerYear_ECID_Temporal(base.ECID, 20181001, 20201005) as SubSeasonsPerYear, MACHINELEARNINGFEATURES.PROD.TotalSeasonsScanned_ECID_Temporal(base.ECID, 20181001, 20201005) as TotalSeasonsScanned, MACHINELEARNINGFEATURES.PROD.TotalVisits_ECID_Temporal(base.ECID, 20181001, 20201005) as TotalVisits, MACHINELEARNINGFEATURES.PROD.VisitMostInPeak_ECID_Temporal(base.ECID, 20181001, 20201005) as VisitMostInPeak

, '2019/20' as SEASONYEAR
from
(select
distinct fs.ECID as ecid,
dd.SeasonYear as SeasonYear
from BIDE_EDWDB_ARA_PROD.dbo.FactScan fs
left join BIDE_EDWDB_ARA_PROD.dbo.DimDateSeason dd
on dd.DateSeasonKey = fs.DateSeasonKey
where
dd.SeasonYear in ('2019/20')
and fs.IsEmployee = 0
and dd.Season = 'Winter'
LIMIT 10000
)base
inner join machinelearningfeatures.prod.featurestore_ecid joined on joined.ecid = base.ecid 
UNION ALL
select
base.*
, joined.DESTINATIONGEOAFINITYLABEL
, joined.GenderCode
, MACHINELEARNINGFEATURES.PROD.Age_ECID_Temporal(base.ECID, 20191001, 20211005) as Age, MACHINELEARNINGFEATURES.PROD.AvgVisitPerSeason_ECID_Temporal(base.ECID, 20191001, 20211005) as AvgVisitPerSeason, MACHINELEARNINGFEATURES.PROD.BoughtPass_ECID_Temporal(base.ECID, '2021/22') as BoughtPass, MACHINELEARNINGFEATURES.PROD.EverCorePass_ECID_Temporal(base.ECID, 20151005, 20211005) as EverCorePass, MACHINELEARNINGFEATURES.PROD.EverPass_ECID_Temporal(base.ECID, 20151005, 20211005) as EverPass, MACHINELEARNINGFEATURES.PROD.GuestBehavior_ECID_Temporal(base.ECID, '2019/20') as GuestBehavior, MACHINELEARNINGFEATURES.PROD.IsEpicMixActivated_ECID_Temporal(base.ECID, '2019/20') as IsEpicMixActivated, MACHINELEARNINGFEATURES.PROD.MarketingZone_ECID_Temporal(base.ECID, '2019/20') as MarketingZone, MACHINELEARNINGFEATURES.PROD.MostCommonTicketComp_ECID_Temporal(base.ECID, 20191001, 20211005) as MostCommonTicketComp, MACHINELEARNINGFEATURES.PROD.MostSubSeasonVisited_ECID_Temporal(base.ECID, 20191001, 20211005) as MostSubSeasonVisited, MACHINELEARNINGFEATURES.PROD.MostVisitedRegion_ECID_Temporal(base.ECID, 20191001, 20211005) as MostVisitedRegion, MACHINELEARNINGFEATURES.PROD.MostVisitedResort_ECID_Temporal(base.ECID, 20191001, 20211005) as MostVisitedResort, MACHINELEARNINGFEATURES.PROD.OnlySingleResortKey_ECID_Temporal(base.ECID, 20191001, 20211005) as OnlySingleResortKey, MACHINELEARNINGFEATURES.PROD.PartnerResortScannerFlag_ECID_Temporal(base.ECID, 20191001, 20211005) as PartnerResortScannerFlag, MACHINELEARNINGFEATURES.PROD.ResortsVisited_ECID_Temporal(base.ECID, 20191001, 20211005) as ResortsVisited, MACHINELEARNINGFEATURES.PROD.SkierabilityLabel_ECID_Temporal(base.ECID, '2019/20') as SkierabilityLabel, MACHINELEARNINGFEATURES.PROD.SubSeasonsPerYear_ECID_Temporal(base.ECID, 20191001, 20211005) as SubSeasonsPerYear, MACHINELEARNINGFEATURES.PROD.TotalSeasonsScanned_ECID_Temporal(base.ECID, 20191001, 20211005) as TotalSeasonsScanned, MACHINELEARNINGFEATURES.PROD.TotalVisits_ECID_Temporal(base.ECID, 20191001, 20211005) as TotalVisits, MACHINELEARNINGFEATURES.PROD.VisitMostInPeak_ECID_Temporal(base.ECID, 20191001, 20211005) as VisitMostInPeak

, '2020/21' as SEASONYEAR
from
(select
distinct fs.ECID as ecid,
dd.SeasonYear as SeasonYear
from BIDE_EDWDB_ARA_PROD.dbo.FactScan fs
left join BIDE_EDWDB_ARA_PROD.dbo.DimDateSeason dd
on dd.DateSeasonKey = fs.DateSeasonKey
where
dd.SeasonYear in ('2020/21')
and fs.IsEmployee = 0
and dd.Season = 'Winter'
LIMIT 10000
)base
inner join machinelearningfeatures.prod.featurestore_ecid joined on joined.ecid = base.ecid
INFO:root:Data lake path for data push projects/LTBP/FY23/LocalRunTest/training_data/
INFO:root:Checking projects/LTBP/FY23/LocalRunTest/training_data/ to either skip creation for experiment or create a production dataset</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>INFO:data_system_utilities.azure.storage:number of files in container path recursively 32
WARNING:root:projects/LTBP/FY23/LocalRunTest/training_data/ already exists this should be do experimentation runs</code></pre>
</div>
</div>
</section>
<section id="grab-data-from-experiment" class="level2">
<h2 class="anchored" data-anchor-id="grab-data-from-experiment">Grab Data From Experiment</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> LTBP.data.utils <span class="im">import</span> snowflake_query, get_yaml_dicts</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> LTBP.modeling.utils <span class="im">import</span> (</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    create_stage_and_query_stage_sf, create_sklearn_preprocess_baseline_dict,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    return_list_of_vars, prepare_training_set, save_sklearn_object_to_data_lake</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>yaml_file_list<span class="op">=</span>[<span class="st">'features.yaml'</span>, <span class="st">'udf_inputs.yaml'</span>,<span class="st">'etl.yaml'</span>,<span class="st">'models.yaml'</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>prod_or_dev <span class="op">=</span> <span class="st">'dev'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>experiment_name<span class="op">=</span><span class="st">'BASELINE'</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>experiment <span class="op">=</span> <span class="va">True</span> <span class="co"># this will trigger if the feature set needs to be created</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>test_set <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab all yaml files for current probject</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>features, udf_inputs, etl_dict, models_dict <span class="op">=</span> get_yaml_dicts(yaml_file_list)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Snowflake Stage and Query Experiment location or commit location and return training data</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>sf <span class="op">=</span> snowflake_query(sfSchema<span class="op">=</span>prod_or_dev <span class="cf">if</span> prod_or_dev.lower() <span class="op">==</span> <span class="st">'dev'</span> <span class="cf">else</span> <span class="st">'LTBP'</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> create_stage_and_query_stage_sf(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    sf<span class="op">=</span>sf,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    etl<span class="op">=</span>etl_dict,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    udf_inputs<span class="op">=</span>udf_inputs,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    train_or_inference<span class="op">=</span><span class="st">'TRAINING'</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    experiment<span class="op">=</span>experiment,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    indentification<span class="op">=</span>models_dict[<span class="st">'identification'</span>]</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f'size of test set </span><span class="sc">{</span>df_train<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>df_train.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:data_system_utilities.snowflake.utils:stage_query: 
 create or replace stage ltbpFY23LocalRunTest
url='azure://vaildtscadls.blob.core.windows.net/vailadls/projects/LTBP/FY23/experiments/BASELINE'
credentials=(azure_sas_token='**MASKED**')
encryption=(type= 'NONE')
file_format = (type = parquet        )
INFO:data_system_utilities.snowflake.utils:connection to snowflake established...
INFO:data_system_utilities.snowflake.query:executing query
INFO:data_system_utilities.snowflake.query:data loaded from snowflake
INFO:data_system_utilities.snowflake.query:connection to snowflake has been turned off
INFO:data_system_utilities.snowflake.query:Stage area LTBPFY23LOCALRUNTEST successfully created.
INFO:root:adls snowflake stage query 
    select
    $1:"ECID"::varchar as ECID
, $1:"SEASONYEAR"::varchar as SEASONYEAR
, $1:"AGE"::varchar as AGE
, $1:"AVGVISITPERSEASON"::varchar as AVGVISITPERSEASON
, $1:"BOUGHTPASS"::varchar as BOUGHTPASS
, $1:"DESTINATIONGEOAFINITYLABEL"::varchar as DESTINATIONGEOAFINITYLABEL
, $1:"EVERCOREPASS"::varchar as EVERCOREPASS
, $1:"EVERPASS"::varchar as EVERPASS
, $1:"GENDERCODE"::varchar as GENDERCODE
, $1:"GUESTBEHAVIOR"::varchar as GUESTBEHAVIOR
, $1:"ISEPICMIXACTIVATED"::varchar as ISEPICMIXACTIVATED
, $1:"MARKETINGZONE"::varchar as MARKETINGZONE
, $1:"MOSTCOMMONTICKETCOMP"::varchar as MOSTCOMMONTICKETCOMP
, $1:"MOSTSUBSEASONVISITED"::varchar as MOSTSUBSEASONVISITED
, $1:"MOSTVISITEDREGION"::varchar as MOSTVISITEDREGION
, $1:"MOSTVISITEDRESORT"::varchar as MOSTVISITEDRESORT
, $1:"ONLYSINGLERESORTKEY"::varchar as ONLYSINGLERESORTKEY
, $1:"PARTNERRESORTSCANNERFLAG"::varchar as PARTNERRESORTSCANNERFLAG
, $1:"RESORTSVISITED"::varchar as RESORTSVISITED
, $1:"SKIERABILITYLABEL"::varchar as SKIERABILITYLABEL
, $1:"SUBSEASONSPERYEAR"::varchar as SUBSEASONSPERYEAR
, $1:"TOTALSEASONSSCANNED"::varchar as TOTALSEASONSSCANNED
, $1:"TOTALVISITS"::varchar as TOTALVISITS
, $1:"VISITMOSTINPEAK"::varchar as VISITMOSTINPEAK

    from @ltbpFY23LocalRunTest/training_data/
    None
    
INFO:data_system_utilities.snowflake.utils:connection to snowflake established...
INFO:data_system_utilities.snowflake.query:executing query
INFO:data_system_utilities.snowflake.query:data loaded from snowflake
INFO:data_system_utilities.snowflake.query:connection to snowflake has been turned off
INFO:root:Preview dataframe queried        ECID SEASONYEAR AGE AVGVISITPERSEASON BOUGHTPASS  \
0  84502625    2018/19  51                 1          0   
1  87132129    2018/19  50               5.5          1   
2   5384667    2018/19  53                 7          1   
3  81281678    2018/19  44                 3          0   
4  59615084    2018/19  41                11          1   

  DESTINATIONGEOAFINITYLABEL EVERCOREPASS EVERPASS GENDERCODE GUESTBEHAVIOR  \
0                      Local            0        0          M          None   
1                Destination            0        1          M      Prospect   
2                Destination            1        1          F       PY Paid   
3                Destination            0        0          M          None   
4                      Local            0        1          U       PY Paid   

   ...  MOSTVISITEDREGION MOSTVISITEDRESORT ONLYSINGLERESORTKEY  \
0  ...  Pacific Southwest                 9                   9   
1  ...  Pacific Northwest                18                None   
2  ...  Pacific Northwest                16                None   
3  ...     Rocky Mountain                16                  16   
4  ...     Rocky Mountain                 1                None   

  PARTNERRESORTSCANNERFLAG RESORTSVISITED SKIERABILITYLABEL SUBSEASONSPERYEAR  \
0                        0              1              None                 1   
1                        0              2              None               2.5   
2                        0              3              None                 4   
3                        0              1              None                 1   
4                        0              1              None                 5   

  TOTALSEASONSSCANNED TOTALVISITS VISITMOSTINPEAK  
0                   1           2               1  
1                   2          11               1  
2                   1           7               0  
3                   1           3               1  
4                   1          11               0  

[5 rows x 24 columns]
INFO:root:size of test set (30000, 24)</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>ECID</th>
      <th>SEASONYEAR</th>
      <th>AGE</th>
      <th>AVGVISITPERSEASON</th>
      <th>BOUGHTPASS</th>
      <th>DESTINATIONGEOAFINITYLABEL</th>
      <th>EVERCOREPASS</th>
      <th>EVERPASS</th>
      <th>GENDERCODE</th>
      <th>GUESTBEHAVIOR</th>
      <th>...</th>
      <th>MOSTVISITEDREGION</th>
      <th>MOSTVISITEDRESORT</th>
      <th>ONLYSINGLERESORTKEY</th>
      <th>PARTNERRESORTSCANNERFLAG</th>
      <th>RESORTSVISITED</th>
      <th>SKIERABILITYLABEL</th>
      <th>SUBSEASONSPERYEAR</th>
      <th>TOTALSEASONSSCANNED</th>
      <th>TOTALVISITS</th>
      <th>VISITMOSTINPEAK</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>84502625</td>
      <td>2018/19</td>
      <td>51</td>
      <td>1</td>
      <td>0</td>
      <td>Local</td>
      <td>0</td>
      <td>0</td>
      <td>M</td>
      <td>None</td>
      <td>...</td>
      <td>Pacific Southwest</td>
      <td>9</td>
      <td>9</td>
      <td>0</td>
      <td>1</td>
      <td>None</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>87132129</td>
      <td>2018/19</td>
      <td>50</td>
      <td>5.5</td>
      <td>1</td>
      <td>Destination</td>
      <td>0</td>
      <td>1</td>
      <td>M</td>
      <td>Prospect</td>
      <td>...</td>
      <td>Pacific Northwest</td>
      <td>18</td>
      <td>None</td>
      <td>0</td>
      <td>2</td>
      <td>None</td>
      <td>2.5</td>
      <td>2</td>
      <td>11</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 24 columns</p>
</div>
</div>
</div>
</section>
<section id="preprocess-training-data" class="level1">
<h1>Preprocess Training Data</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> machine_learning_utilities <span class="im">import</span> preprocessing</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing an adls path depending on experiment being true or false</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>adls_path <span class="op">=</span> os.path.join((os.path.join(etl_dict[<span class="st">'data_lake_path'</span>], <span class="st">'experiments'</span>, experiment_name)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> experiment </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> os.path.join(etl_dict[<span class="st">'data_lake_path'</span>], </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    os.environ.get(<span class="st">'CI_COMMIT_SHA'</span>, <span class="st">'LocalRunNBS'</span>)))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    , models_dict[<span class="st">'preprocessors_adls_path'</span>])</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab all Categorical and Continous Variables for Modeling</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="op">=</span>[{f.upper() : values[<span class="st">'transformation'</span>][experiment_name]} <span class="cf">for</span> f, values <span class="kw">in</span> features.items() </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> values[<span class="st">'var_type'</span>][experiment_name] <span class="op">==</span> <span class="st">'cat'</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">and</span> values[<span class="st">'input_definition'</span>] <span class="op">!=</span> <span class="st">'LABEL'</span>]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>cont_vars <span class="op">=</span>[{f.upper(): values[<span class="st">'transformation'</span>][experiment_name]} <span class="cf">for</span> f, values <span class="kw">in</span> features.items() </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> values[<span class="st">'var_type'</span>][experiment_name] <span class="op">==</span> <span class="st">'cont'</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">and</span> values[<span class="st">'input_definition'</span>] <span class="op">!=</span> <span class="st">'LABEL'</span>]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>y_var<span class="op">=</span>[k.upper() <span class="cf">for</span> k, v <span class="kw">in</span> features.items() <span class="cf">if</span> v[<span class="st">'input_definition'</span>] <span class="op">==</span> <span class="st">'LABEL'</span>]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Dictionary and create sklearn preprocessing Pipeline</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>feature_dict <span class="op">=</span> create_sklearn_preprocess_baseline_dict(cat_vars<span class="op">=</span>cat_vars, </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                                                       cont_vars<span class="op">=</span>cont_vars)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>logging.info(feature_dict)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="op">=</span> return_list_of_vars(cat_vars)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>cont_vars <span class="op">=</span> return_list_of_vars(cont_vars)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f"categorical variables: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>cat_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="ss">f"continous variables: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>cont_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> preprocessing.generate_sklearn_preprocessing_pipeline(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    feature_dict, impute<span class="op">=</span><span class="va">True</span>, impute_strategy<span class="op">=</span><span class="st">'mean'</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess and split data set to return neccessary object for modeling</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> prepare_training_set(df_train,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                              y_var<span class="op">=</span>[k.upper() <span class="cf">for</span> k, v <span class="kw">in</span> features.items() <span class="cf">if</span> v[<span class="st">'input_definition'</span>] <span class="op">==</span> <span class="st">'LABEL'</span>],</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                              y_scaler_type<span class="op">=</span>models_dict[experiment_name][<span class="st">'y_scaler_type'</span>],</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                              adls_path<span class="op">=</span>adls_path,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                              sklearn_pipe<span class="op">=</span>pipe,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                              test_set<span class="op">=</span>test_set,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                              etl_dict<span class="op">=</span>etl_dict,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                              models_dict<span class="op">=</span>models_dict,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                              connection_str<span class="op">=</span>os.environ[models_dict[<span class="st">"connection_str"</span>]],</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                              experiment_name<span class="op">=</span>experiment_name,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                              as_type<span class="op">=</span><span class="bu">int</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                              identifiers<span class="op">=</span>[<span class="st">'ECID'</span>, <span class="st">'SEASONYEAR'</span>]</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                              )</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> test_set:</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    X_train, X_valid, X_test, y_train, y_valid, y_test, sklearn_pipe, scaler, id_list <span class="op">=</span> result</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    X_train, X_valid, y_train, y_valid, sklearn_pipe, scaler, id_list <span class="op">=</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:{'DESTINATIONGEOAFINITYLABEL': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'EVERCOREPASS': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'EVERPASS': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'GENDERCODE': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'GUESTBEHAVIOR': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'ISEPICMIXACTIVATED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MARKETINGZONE': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTCOMMONTICKETCOMP': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTSUBSEASONVISITED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTVISITEDREGION': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'MOSTVISITEDRESORT': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'ONLYSINGLERESORTKEY': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'PARTNERRESORTSCANNERFLAG': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'SKIERABILITYLABEL': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'TOTALSEASONSSCANNED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'VISITMOSTINPEAK': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'AGE': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'AVGVISITPERSEASON': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'RESORTSVISITED': {'transformation': {'name': 'OrdinalEncoder', 'args': {'handle_unknown': 'use_encoded_value', 'unknown_value': -1}}, 'variable_type': 'cat'}, 'SUBSEASONSPERYEAR': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}, 'TOTALVISITS': {'transformation': {'name': 'StandardScaler', 'args': {}}, 'variable_type': 'cont'}}
INFO:root:categorical variables: 
 ['DESTINATIONGEOAFINITYLABEL', 'EVERCOREPASS', 'EVERPASS', 'GENDERCODE', 'GUESTBEHAVIOR', 'ISEPICMIXACTIVATED', 'MARKETINGZONE', 'MOSTCOMMONTICKETCOMP', 'MOSTSUBSEASONVISITED', 'MOSTVISITEDREGION', 'MOSTVISITEDRESORT', 'ONLYSINGLERESORTKEY', 'PARTNERRESORTSCANNERFLAG', 'SKIERABILITYLABEL', 'TOTALSEASONSSCANNED', 'VISITMOSTINPEAK']
INFO:root:continous variables: 
 ['AGE', 'AVGVISITPERSEASON', 'RESORTSVISITED', 'SUBSEASONSPERYEAR', 'TOTALVISITS']
INFO:machine_learning_utilities.preprocessing:Creating Sklearn Preprocessing Pipeline
INFO:machine_learning_utilities.preprocessing:Feature: DESTINATIONGEOAFINITYLABEL --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: EVERCOREPASS --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: EVERPASS --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: GENDERCODE --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: GUESTBEHAVIOR --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: ISEPICMIXACTIVATED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MARKETINGZONE --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTCOMMONTICKETCOMP --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTSUBSEASONVISITED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTVISITEDREGION --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: MOSTVISITEDRESORT --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: ONLYSINGLERESORTKEY --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: PARTNERRESORTSCANNERFLAG --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: SKIERABILITYLABEL --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: TOTALSEASONSSCANNED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: VISITMOSTINPEAK --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: AGE --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: AVGVISITPERSEASON --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: RESORTSVISITED --&gt; Transformer: OrdinalEncoder(handle_unknown='use_encoded_value', unknown_value=-1)
INFO:machine_learning_utilities.preprocessing:Feature: SUBSEASONSPERYEAR --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Feature: TOTALVISITS --&gt; Transformer: StandardScaler()
INFO:machine_learning_utilities.preprocessing:Imputing missing data with mean strategy
INFO:machine_learning_utilities.preprocessing:Preprocessing Pipeline Object:
Pipeline(steps=[('preprocessing',
                 FeatureUnion(transformer_list=[('pipeline-1',
                                                 Pipeline(steps=[('functiontransformer',
                                                                  FunctionTransformer(func=&lt;function get_cat_cols&gt;,
                                                                                      kw_args={'cols': ['DESTINATIONGEOAFINITYLABEL']})),
                                                                 ('ordinalencoder',
                                                                  OrdinalEncoder(handle_unknown='use_encoded_value',
                                                                                 unknown_value=-1))])),
                                                ('pipeline-2',
                                                 Pipeline(steps=[('...
                                                                  FunctionTransformer(func=&lt;function get_cont_cols&gt;,
                                                                                      kw_args={'cols': ['SUBSEASONSPERYEAR']})),
                                                                 ('standardscaler',
                                                                  StandardScaler())])),
                                                ('pipeline-21',
                                                 Pipeline(steps=[('functiontransformer',
                                                                  FunctionTransformer(func=&lt;function get_cont_cols&gt;,
                                                                                      kw_args={'cols': ['TOTALVISITS']})),
                                                                 ('standardscaler',
                                                                  StandardScaler())]))])),
                ('imputing', SimpleImputer())])</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Successfully Spilt Data
Train: (24000, 24), (24000, 1)
Valid: (5100, 24), (5100, 1)
Test: (900, 24), (900, 1)
INFO:root:Size of the id_list for the hold set (900, 2)
INFO:root:This project relies on the query to have accurate labels with no preprocessing..
INFO:root:Pushing Sklearn Object to Azure: projects/LTBP/FY23/experiments/BASELINE/preprocessors/LocalRunTeststandard_pipe.pickle
INFO:data_system_utilities.azure.storage:Uploading LocalRunTeststandard_pipe.pickle, to Azure Storage projects/LTBP/FY23/experiments/BASELINE/preprocessors/LocalRunTeststandard_pipe.pickle
INFO:data_system_utilities.azure.storage:Azure Upload Complete
INFO:root:LocalRunTeststandard_pipe.pickle successfully pushed to projects/LTBP/FY23/experiments/BASELINE/preprocessors/</code></pre>
</div>
</div>
<section id="training-model" class="level2">
<h2 class="anchored" data-anchor-id="training-model">Training Model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> LTBP.modeling.models <span class="im">as</span> ds_models</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="how-to-change-model-in-notebook" class="level3">
<h3 class="anchored" data-anchor-id="how-to-change-model-in-notebook">How to Change Model In Notebook</h3>
<p>This current code will run the model that is expected to run, but feel make the following change to train a logistic regression.</p>
<ul>
<li><em>models_dict[experiment_name][‘model_trainer’]</em> –&gt; ‘train_logistic’</li>
</ul>
<blockquote class="blockquote">
<p>this simply takes the model from models.py</p>
</blockquote>
<p>You could also develop a new model in the notebook and push it out against your data set and see what the results are by running the following code this is just where this notebook is trying add flexibility as the overview stated</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_xgb_basic(X_train, X_valid, y_train, y_valid, early_stop<span class="op">=</span><span class="dv">10</span>, verbose<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>args):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Binary Classifiation Xgboost Sklearn API Call Basic HyperParameters</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f'Training on </span><span class="sc">{</span>X_train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> rows'</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> xgb.XGBClassifier(n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    eval_set <span class="op">=</span> [(X_valid, y_valid)]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train, eval_set<span class="op">=</span>eval_set, early_stopping_rounds<span class="op">=</span>early_stop, verbose<span class="op">=</span>verbose)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="train-model" class="level3">
<h3 class="anchored" data-anchor-id="train-model">Train Model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing model from models.py to use from models.yaml file</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model_trainer <span class="op">=</span> <span class="bu">getattr</span>(ds_models, models_dict[experiment_name][<span class="st">'model_trainer'</span>])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_trainer(X_train,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                      X_valid,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                      y_train,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                      y_valid,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                      evals<span class="op">=</span>models_dict[experiment_name][<span class="st">'hyperopt_evals'</span>],</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                      sub<span class="op">=</span>models_dict[experiment_name][<span class="st">'hyper_opt_subsample_size'</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                      train<span class="op">=</span>models_dict[experiment_name][<span class="st">'training_subsample_size'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Hyper tuning on 24000 rows</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%|                                       | 0/2 [00:00&lt;?, ?trial/s, best loss=?]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:hyperopt.tpe:build_posterior_wrapper took 0.008194 seconds
INFO:hyperopt.tpe:TPE using 0 trials</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> 50%|██████      | 1/2 [00:04&lt;00:04,  4.36s/trial, best loss: 0.09959774525630516]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:hyperopt.tpe:build_posterior_wrapper took 0.007341 seconds
INFO:hyperopt.tpe:TPE using 1/1 trials with best loss 0.099598</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>100%|████████████| 2/2 [00:17&lt;00:00,  8.86s/trial, best loss: 0.09959774525630516]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Full training on 24000 rows</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
</div>
</section>
</section>
<section id="evaluating-model-results" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-model-results">Evaluating Model Results</h2>
<p>The code below is just a simple function inside of Modeling Utilities Custom Notebook that evaluates the model the way that a user might want to do this is where you would be able to evaluate the model in a custom way or see how the plots look for your model.</p>
<p>An example of this is if you were using prophet for a forecast model you could really benefit from seeing the component plots that come out of that library to be able to make decision on where to investigate next this was very useful in the process for resort visitation forecasting</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> LTBP.modeling.custom_utils <span class="im">import</span> evaluate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>result_dict <span class="op">=</span> {}</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="st">'Training Set Evaluation'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>eval_list_train <span class="op">=</span> evaluate(model, X_train, y_train, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>metric1, metric2, metric3, columns, _, _, fi_permutation <span class="op">=</span> eval_list_train</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'training_metrics'</span>]<span class="op">=</span>{k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'fi_train'</span>]<span class="op">=</span>{k:v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>logging.info(<span class="st">'Validation Set Evaluation'</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>eval_list_valid <span class="op">=</span> evaluate(model, X_valid, y_valid, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>metric1, metric2, metric3, columns, y_pred_proba, y_pred, fi_permutation <span class="op">=</span> eval_list_train</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'valid_metrics'</span>]<span class="op">=</span>{k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>result_dict[<span class="st">'fi_valid'</span>]<span class="op">=</span>{k:v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> X_test <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Test Set Evaluation'</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    eval_list_test <span class="op">=</span> evaluate(model, X_test, y_test, y_var, feature_importance<span class="op">=</span><span class="va">True</span>, plot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    metric1, metric2, metric3, columns, y_pred_proba, y_pred, fi_permutation <span class="op">=</span> eval_list_test</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    result_dict[<span class="st">'test_metrics'</span>]<span class="op">=</span>{k: v <span class="cf">for</span> k, v <span class="kw">in</span> <span class="bu">zip</span>(columns, [metric1]<span class="op">+</span>[metric2]<span class="op">+</span>[metric3])}</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    result_dict[<span class="st">'fi_test'</span>]<span class="op">=</span>{k:v <span class="cf">for</span> k, v <span class="kw">in</span> fi_permutation[:<span class="dv">10</span>].values}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Training Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.928    Accuracy: 0.852    Balanced Accuracy: 0.853
INFO:root:Feature Importance df: 
                           COLS     IMP
0                     EVERPASS  0.2228
1         MOSTCOMMONTICKETCOMP  0.0300
2            SUBSEASONSPERYEAR  0.0240
3                GUESTBEHAVIOR  0.0156
4                          AGE  0.0118
5                 EVERCOREPASS  0.0116
6   DESTINATIONGEOAFINITYLABEL  0.0110
7            AVGVISITPERSEASON  0.0078
8           ISEPICMIXACTIVATED  0.0070
9            SKIERABILITYLABEL  0.0058
10         ONLYSINGLERESORTKEY  0.0052
11           MOSTVISITEDRESORT  0.0044
12               MARKETINGZONE  0.0042
13              RESORTSVISITED  0.0040
14                 TOTALVISITS  0.0040
15        MOSTSUBSEASONVISITED  0.0034
16           MOSTVISITEDREGION  0.0030
17         TOTALSEASONSSCANNED  0.0022
18                  GENDERCODE  0.0014
19             VISITMOSTINPEAK  0.0008
20    PARTNERRESORTSCANNERFLAG -0.0004</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Validation Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.901    Accuracy: 0.828    Balanced Accuracy: 0.830
INFO:root:Feature Importance df: 
                           COLS     IMP
0                     EVERPASS  0.2262
1         MOSTCOMMONTICKETCOMP  0.0302
2            SUBSEASONSPERYEAR  0.0214
3                GUESTBEHAVIOR  0.0112
4                 EVERCOREPASS  0.0088
5   DESTINATIONGEOAFINITYLABEL  0.0084
6                          AGE  0.0076
7            MOSTVISITEDRESORT  0.0066
8           ISEPICMIXACTIVATED  0.0064
9                  TOTALVISITS  0.0048
10         TOTALSEASONSSCANNED  0.0044
11           AVGVISITPERSEASON  0.0030
12           MOSTVISITEDREGION  0.0028
13               MARKETINGZONE  0.0016
14         ONLYSINGLERESORTKEY  0.0016
15                  GENDERCODE  0.0016
16             VISITMOSTINPEAK  0.0014
17              RESORTSVISITED  0.0014
18           SKIERABILITYLABEL  0.0006
19    PARTNERRESORTSCANNERFLAG  0.0002
20        MOSTSUBSEASONVISITED  0.0000</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-5.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-6.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-7.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:root:Test Set Evaluation
INFO:root:Variable(s) of interest ['BOUGHTPASS'] AUC: 0.900    Accuracy: 0.829    Balanced Accuracy: 0.830
INFO:root:Feature Importance df: 
                           COLS       IMP
0                     EVERPASS  0.222222
1         MOSTCOMMONTICKETCOMP  0.036667
2            SUBSEASONSPERYEAR  0.012222
3                GUESTBEHAVIOR  0.011111
4                 EVERCOREPASS  0.011111
5            MOSTVISITEDREGION  0.010000
6            AVGVISITPERSEASON  0.010000
7         MOSTSUBSEASONVISITED  0.006667
8          ONLYSINGLERESORTKEY  0.006667
9                          AGE  0.005556
10             VISITMOSTINPEAK  0.003333
11               MARKETINGZONE  0.002222
12              RESORTSVISITED  0.002222
13          ISEPICMIXACTIVATED  0.001111
14  DESTINATIONGEOAFINITYLABEL  0.001111
15    PARTNERRESORTSCANNERFLAG  0.000000
16           SKIERABILITYLABEL  0.000000
17         TOTALSEASONSSCANNED  0.000000
18           MOSTVISITEDRESORT -0.001111
19                  GENDERCODE -0.001111
20                 TOTALVISITS -0.003333</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-9.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-10.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-11.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="Modeling_Example_files/figure-html/cell-11-output-12.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="final-remarks" class="level1">
<h1>Final Remarks</h1>
<p>The number of changes and the future of this type of work is really exciting this is purely a POC of what this walk through right now this is here to help the 2022/23 winter work load to move some of our existing models into a template that we can build on.</p>
<p>This a great work in progress notebook that could add SHAP, feature selection processes, so many more things these examples would be where people can come in and look at experiments that the last person did to make sure that they don’t go over the same thing or maybe there is just an interest to see it run this would be where it lives</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>